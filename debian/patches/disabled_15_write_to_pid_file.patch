--- spamass-milt/spamass-milter.cpp:1.69	Fri Sep 12 05:45:05 2003
+++ spamass-milt/spamass-milter.cpp	Tue Oct 21 21:40:32 2003
@@ -174,7 +174,7 @@
 main(int argc, char* argv[])
 {
    int c, err = 0;
-   const char *args = "p:fd:mr:u:D:i:b:B:";
+   const char *args = "fd:mp:P:r:u:D:i:b:B:";
    char *sock = NULL;
    bool dofork = false;

@@ -177,15 +177,14 @@
    const char *args = "p:fd:mr:u:D:i:b:B:";
    char *sock = NULL;
    bool dofork = false;
+   char *pidfilename = NULL;
+   FILE *pidfile = NULL;
 
    openlog("spamass-milter", LOG_PID, LOG_MAIL);
 
 	/* Process command line options */
 	while ((c = getopt(argc, argv, args)) != -1) {
 		switch (c) {
-			case 'p':
-				sock = strdup(optarg);
-				break;
 			case 'f':
 				dofork = true;
 				break;
@@ -215,6 +209,12 @@
 				dontmodifyspam = true;
 				smfilter.xxfi_flags &= ~(SMFIF_CHGBODY|SMFIF_CHGHDRS);
 				break;
+			case 'p':
+				sock = strdup(optarg);
+				break;
+			case 'P':
+				pidfilename = strdup(optarg);
+				break;
 			case 'r':
 				flag_reject = true;
 				reject_score = atoi(optarg);
@@ -287,18 +287,37 @@
       exit(EX_USAGE);
    }
 
-	if (dofork == true) {
-		switch(fork()) {
-         case -1: /* Uh-oh, we have a problem forking. */
-            fprintf(stderr, "Uh-oh, couldn't fork!\n");
-				exit(errno);
-				break;
-			case 0: /* Child */
-				break;
-			default: /* Parent */
-				exit(0);
+	if (pidfilename)
+	{
+		unlink(pidfilename);
+		pidfile = fopen(pidfilename,"w");
+		if (!pidfile)
+		{
+			fprintf(stderr, "Could not open pidfile: %s\n", strerror(errno));
+			exit(1);
+		}
+		/* leave the file open through the fork, since we don't know our pid
+		   yet
+		*/
+	}
+
+
+	if (dofork == true) 
+	{
+		if (daemon(0, 0) == -1)
+		{
+            fprintf(stderr, "daemon() failed: %s\n", strerror(errno));
+            exit(1);
 		}
 	}
+	
+	if (pidfile)
+	{
+		fprintf(pidfile, "%ld\n", (long)getpid());
+		fclose(pidfile);
+		pidfile = NULL;
+	}	
+	
    {
       struct stat junk;
       if (stat(sock,&junk) == 0) unlink(sock);
@@ -314,7 +333,9 @@
 	debug(D_ALWAYS, "spamass-milter %s starting", PACKAGE_VERSION);
 	err = smfi_main();
 	debug(D_ALWAYS, "spamass-milter %s exiting", PACKAGE_VERSION);
+	if (pidfilename)
+		unlink(pidfilename);
 	return err;
 }
 
